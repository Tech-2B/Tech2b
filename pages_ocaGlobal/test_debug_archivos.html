<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Archivos en Modal</title>
    <link href="css/administradorClientes.css" rel="stylesheet">
    <link href="css/visorHistorialArchivos.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .debug-section h3 {
            color: #00a7b5;
            margin-bottom: 15px;
        }
        .btn-test {
            margin: 5px;
        }
        .debug-output {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="text-center mb-4">
            <i class="fa fa-bug"></i> Debug - Archivos en Modal
        </h1>

        <!-- Test de Datos de Archivos -->
        <div class="debug-section">
            <h3><i class="fa fa-file"></i> Test de Datos de Archivos</h3>
            <p>Simulación de la respuesta del servidor para WALMART (cliente ID 4, plan 1).</p>
            
            <div class="text-center mb-3">
                <button type="button" class="btn btn-primary btn-lg btn-test" onclick="debugArchivos.simularRespuestaServidor()">
                    <i class="fa fa-server"></i> Simular Respuesta del Servidor
                </button>
                <button type="button" class="btn btn-success btn-lg btn-test" onclick="debugArchivos.probarMostrarArchivos()">
                    <i class="fa fa-eye"></i> Probar Mostrar Archivos
                </button>
                <button type="button" class="btn btn-info btn-lg btn-test" onclick="debugArchivos.abrirModalCompleto()">
                    <i class="fa fa-folder-open"></i> Abrir Modal Completo
                </button>
            </div>

            <div id="debug-output" class="debug-output">
                <p class="text-muted">Haz click en los botones para ver el debug paso a paso.</p>
            </div>
        </div>

        <!-- Test del Modal -->
        <div class="debug-section">
            <h3><i class="fa fa-window-maximize"></i> Test del Modal</h3>
            <p>Prueba la funcionalidad completa del modal con datos reales.</p>
            
            <div class="text-center mb-3">
                <button type="button" class="btn btn-warning btn-lg btn-test" onclick="debugArchivos.testSeleccionCarpeta()">
                    <i class="fa fa-mouse-pointer"></i> Test Selección de Carpeta
                </button>
                <button type="button" class="btn btn-danger btn-lg btn-test" onclick="debugArchivos.limpiarDebug()">
                    <i class="fa fa-trash"></i> Limpiar Debug
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Estructura de Carpetas -->
    <div id="modal_carpetas" class="modal-carpetas">
        <div class="modal-carpetas-contenido">
            <div class="modal-carpetas-header">
                <h5><i class="fa fa-folder"></i> Estructura de Carpetas</h5>
                <span class="modal-carpetas-cerrar" onclick="debugArchivos.cerrarModalCarpetas()">&times;</span>
            </div>
            <div class="modal-carpetas-body">
                <!-- Información del plan de acción seleccionado -->
                <div class="info-plan-seleccionado mb-3">
                    <h6 id="nombre_plan_seleccionado">Plan de Acción de Prueba</h6>
                </div>
                
                <!-- Área de carpetas (arriba) -->
                <div class="area-carpetas">
                    <h6><i class="fa fa-folder"></i> Carpetas Disponibles</h6>
                    <div class="arbol-carpetas-modal" id="arbol_carpetas_modal">
                        <div class="text-center text-muted">
                            <i class="fa fa-folder-open fa-2x mb-2"></i>
                            <p>Cargando estructura de carpetas...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Área de archivos (abajo) -->
                <div class="area-archivos" id="area_archivos" style="display: none;">
                    <h6><i class="fa fa-file"></i> Archivos de la Carpeta Seleccionada</h6>
                    <div class="lista-archivos-modal" id="lista_archivos_modal">
                        <!-- Los archivos se cargarán aquí dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        class DebugArchivos {
            constructor() {
                this.datosArchivos = [
                    {
                        "id_archivo": 9,
                        "id_archivo_drive": "1REjcWzCHTt9oj2UHrwYp1FmwqA7uNPsX",
                        "nombre_archivo": "Ced_8206 (1) (1).pdf",
                        "nombre_archivo_original": "Ced_8206 (1) (1).pdf",
                        "tipo_archivo": "application/pdf",
                        "tamano_archivo": 1281445,
                        "tamano_formateado": "1.22 MB",
                        "comentario": "",
                        "url_drive": "https://drive.google.com/file/d/1REjcWzCHTt9oj2UHrwYp1FmwqA7uNPsX/view?usp=drivesdk",
                        "url_descarga": "https://drive.google.com/uc?id=1REjcWzCHTt9oj2UHrwYp1FmwqA7uNPsX&export=download",
                        "fecha_subida": "2025-09-16 15:17:58",
                        "fecha_formateada": "16/09/2025 15:17",
                        "id_usuario_subida": 914,
                        "nombre_usuario": "Test Oca",
                        "nombre_carpeta": " 1. Reforzamiento de la estructura del departamento de Servicios HS, asegurando que cada Coordinador HS tenga a su cargo máximo entre 10 y 15 cascos rojos independientes (dependiendo la duración de los proyectos y la zona de los mismos) ",
                        "icono_tipo": {
                            "icono": "fa-file-pdf",
                            "clase": "pdf"
                        }
                    },
                    {
                        "id_archivo": 7,
                        "id_archivo_drive": "14Rw6v3VkBj2W5yPYfwMjizXPI6Y6dACF",
                        "nombre_archivo": "Ced_8206 (1).pdf",
                        "nombre_archivo_original": "Ced_8206 (1).pdf",
                        "tipo_archivo": "application/pdf",
                        "tamano_archivo": 1281445,
                        "tamano_formateado": "1.22 MB",
                        "comentario": "pruebas",
                        "url_drive": "https://drive.google.com/file/d/14Rw6v3VkBj2W5yPYfwMjizXPI6Y6dACF/view?usp=drivesdk",
                        "url_descarga": "https://drive.google.com/uc?id=14Rw6v3VkBj2W5yPYfwMjizXPI6Y6dACF&export=download",
                        "fecha_subida": "2025-09-16 14:27:52",
                        "fecha_formateada": "16/09/2025 14:27",
                        "id_usuario_subida": 914,
                        "nombre_usuario": "Test Oca",
                        "nombre_carpeta": " 1. Reforzamiento de la estructura del departamento de Servicios HS, asegurando que cada Coordinador HS tenga a su cargo máximo entre 10 y 15 cascos rojos independientes (dependiendo la duración de los proyectos y la zona de los mismos) ",
                        "icono_tipo": {
                            "icono": "fa-file-pdf",
                            "clase": "pdf"
                        }
                    }
                ];

                this.estructuraCarpetas = [
                    {
                        id_carpeta_drive: 'carpeta_principal',
                        nombre_carpeta: '1. Reforzamiento de la estructura del departamento de Servicios HS...',
                        tipo_carpeta: 'plan_accion',
                        subcarpetas: [
                            {
                                id_carpeta_drive: 'subcarpeta_1',
                                nombre_carpeta: 'subcarpeta walmart plan 1.1',
                                tipo_carpeta: 'subcarpeta',
                                subcarpetas: []
                            },
                            {
                                id_carpeta_drive: 'subcarpeta_2',
                                nombre_carpeta: 'subcarpeta walmart plan 1.2',
                                tipo_carpeta: 'subcarpeta',
                                subcarpetas: []
                            }
                        ]
                    }
                ];
            }

            log(message) {
                const output = document.getElementById('debug-output');
                const timestamp = new Date().toLocaleTimeString();
                output.textContent += `[${timestamp}] ${message}\n`;
                output.scrollTop = output.scrollHeight;
            }

            simularRespuestaServidor() {
                this.log('=== SIMULANDO RESPUESTA DEL SERVIDOR ===');
                
                const respuesta = {
                    "code": 200,
                    "success": true,
                    "icon": "success",
                    "title": "¡Éxito!",
                    "message": "Los datos han sido encontrados correctamente.",
                    "data": this.datosArchivos
                };

                this.log('Respuesta del servidor:');
                this.log(JSON.stringify(respuesta, null, 2));
                
                this.log('Número de archivos en la respuesta: ' + respuesta.data.length);
                
                // Verificar estructura de cada archivo
                respuesta.data.forEach((archivo, index) => {
                    this.log(`Archivo ${index + 1}:`);
                    this.log(`  - ID Drive: ${archivo.id_archivo_drive}`);
                    this.log(`  - Nombre: ${archivo.nombre_archivo_original}`);
                    this.log(`  - Tamaño: ${archivo.tamano_formateado}`);
                    this.log(`  - Icono: ${archivo.icono_tipo.icono}`);
                });
            }

            probarMostrarArchivos() {
                this.log('=== PROBANDO MOSTRAR ARCHIVOS ===');
                
                const contenedor = document.getElementById('lista_archivos_modal');
                if (!contenedor) {
                    this.log('❌ ERROR: No se encontró el contenedor lista_archivos_modal');
                    return;
                }
                
                this.log('✅ Contenedor encontrado: lista_archivos_modal');
                
                // Mostrar área de archivos
                const areaArchivos = document.getElementById('area_archivos');
                if (areaArchivos) {
                    areaArchivos.style.display = 'block';
                    this.log('✅ Área de archivos mostrada');
                } else {
                    this.log('❌ ERROR: No se encontró el área de archivos');
                }
                
                // Llamar a la función mostrarArchivosEnModal
                this.mostrarArchivosEnModal(this.datosArchivos, 'Carpeta Principal');
                this.log('✅ Función mostrarArchivosEnModal ejecutada');
            }

            mostrarArchivosEnModal(archivos, nombreCarpeta) {
                const contenedor = document.getElementById('lista_archivos_modal');
                if (!contenedor) {
                    this.log('❌ ERROR: No se encontró el contenedor en mostrarArchivosEnModal');
                    return;
                }

                this.log(`Mostrando ${archivos.length} archivos para la carpeta: ${nombreCarpeta}`);

                if (archivos.length === 0) {
                    contenedor.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="fa fa-file fa-2x mb-2"></i>
                            <p>No hay archivos en "${nombreCarpeta}"</p>
                        </div>
                    `;
                    this.log('✅ Mostrando mensaje de "sin archivos"');
                    return;
                }

                let html = '';
                archivos.forEach((archivo, index) => {
                    this.log(`Generando HTML para archivo ${index + 1}: ${archivo.nombre_archivo_original}`);
                    html += this.generarHTMLArchivoModal(archivo);
                });

                contenedor.innerHTML = html;
                this.log(`✅ HTML generado y insertado en el contenedor (${archivos.length} archivos)`);
            }

            generarHTMLArchivoModal(archivo) {
                return `
                    <div class="archivo-item" onclick="debugArchivos.seleccionarArchivo('${archivo.id_archivo_drive}', '${archivo.nombre_archivo_original}')">
                        <i class="fa ${archivo.icono_tipo.icono} icono-archivo ${archivo.icono_tipo.clase}"></i>
                        <span class="nombre-archivo">${archivo.nombre_archivo_original}</span>
                        <span class="tamano-archivo">${archivo.tamano_formateado}</span>
                        <span class="fecha-archivo">${archivo.fecha_formateada}</span>
                        <div class="acciones-archivo">
                            <button class="btn-accion-archivo" onclick="event.stopPropagation(); debugArchivos.verArchivo('${archivo.url_drive}')" title="Ver archivo">
                                <i class="fa fa-eye"></i>
                            </button>
                            <button class="btn-accion-archivo" onclick="event.stopPropagation(); debugArchivos.descargarArchivo('${archivo.url_descarga}', '${archivo.nombre_archivo_original}')" title="Descargar archivo">
                                <i class="fa fa-download"></i>
                            </button>
                        </div>
                    </div>
                `;
            }

            seleccionarArchivo(idArchivoDrive, nombreArchivo) {
                this.log(`Archivo seleccionado: ${nombreArchivo} (ID: ${idArchivoDrive})`);
                Swal.fire({
                    icon: 'info',
                    title: 'Archivo Seleccionado',
                    text: `Has seleccionado: ${nombreArchivo}`,
                    timer: 2000,
                    showConfirmButton: false
                });
            }

            verArchivo(urlDrive) {
                this.log(`Ver archivo: ${urlDrive}`);
                Swal.fire({
                    icon: 'info',
                    title: 'Ver Archivo',
                    text: 'Funcionalidad de ver archivo simulada',
                    timer: 2000,
                    showConfirmButton: false
                });
            }

            descargarArchivo(urlDescarga, nombreArchivo) {
                this.log(`Descargar archivo: ${nombreArchivo}`);
                Swal.fire({
                    icon: 'success',
                    title: 'Descargar Archivo',
                    text: `Descargando: ${nombreArchivo}`,
                    timer: 2000,
                    showConfirmButton: false
                });
            }

            abrirModalCompleto() {
                this.log('=== ABRIENDO MODAL COMPLETO ===');
                
                // Mostrar estructura de carpetas
                this.mostrarEstructuraCarpetas();
                
                // Abrir modal
                const modal = document.getElementById('modal_carpetas');
                if (modal) {
                    modal.style.display = 'block';
                    this.log('✅ Modal abierto');
                } else {
                    this.log('❌ ERROR: No se encontró el modal');
                }
            }

            mostrarEstructuraCarpetas() {
                const contenedor = document.getElementById('arbol_carpetas_modal');
                if (!contenedor) {
                    this.log('❌ ERROR: No se encontró el contenedor del árbol de carpetas');
                    return;
                }

                let html = '';
                this.estructuraCarpetas.forEach(carpeta => {
                    html += this.generarHTMLCarpetaArbol(carpeta, 0);
                });

                contenedor.innerHTML = html;
                this.log('✅ Estructura de carpetas mostrada');
            }

            generarHTMLCarpetaArbol(carpeta, nivel) {
                const nivelClass = nivel > 0 ? `nivel-${nivel}` : '';
                const icono = carpeta.tipo_carpeta === 'plan_accion' ? 'fa-folder' : 'fa-folder';
                
                let html = `
                    <div class="carpeta-item ${nivelClass}" 
                         data-id-carpeta="${carpeta.id_carpeta_drive}" 
                         data-tipo="${carpeta.tipo_carpeta}"
                         onclick="debugArchivos.seleccionarCarpeta('${carpeta.id_carpeta_drive}', '${carpeta.nombre_carpeta}')">
                        <i class="fa ${icono} icono-carpeta"></i>
                        <span class="nombre-carpeta">${carpeta.nombre_carpeta}</span>
                        <span class="contador-archivos" id="contador-${carpeta.id_carpeta_drive}">0</span>
                    </div>
                `;

                // Agregar subcarpetas recursivamente
                if (carpeta.subcarpetas && carpeta.subcarpetas.length > 0) {
                    carpeta.subcarpetas.forEach(subcarpeta => {
                        html += this.generarHTMLCarpetaArbol(subcarpeta, nivel + 1);
                    });
                }

                return html;
            }

            seleccionarCarpeta(idCarpetaDrive, nombreCarpeta) {
                this.log(`=== SELECCIONANDO CARPETA ===`);
                this.log(`Carpeta seleccionada: ${nombreCarpeta} (ID: ${idCarpetaDrive})`);
                
                // Actualizar estado visual en el árbol
                this.actualizarSeleccionCarpetaArbol(idCarpetaDrive);
                
                // Mostrar área de archivos
                this.mostrarAreaArchivos(true);
                
                // Simular carga de archivos
                this.mostrarCargandoArchivos(true, `Cargando archivos de "${nombreCarpeta}"...`);
                
                setTimeout(() => {
                    this.mostrarCargandoArchivos(false);
                    this.mostrarArchivosEnModal(this.datosArchivos, nombreCarpeta);
                }, 1000);
            }

            actualizarSeleccionCarpetaArbol(idCarpetaDrive) {
                // Remover selección anterior
                document.querySelectorAll('.arbol-carpetas-modal .carpeta-item').forEach(item => {
                    item.classList.remove('seleccionada');
                });

                // Agregar selección a la carpeta actual
                const carpetaSeleccionada = document.querySelector(`.arbol-carpetas-modal [data-id-carpeta="${idCarpetaDrive}"]`);
                if (carpetaSeleccionada) {
                    carpetaSeleccionada.classList.add('seleccionada');
                    this.log('✅ Carpeta seleccionada visualmente');
                } else {
                    this.log('❌ ERROR: No se encontró la carpeta para seleccionar');
                }
            }

            mostrarAreaArchivos(mostrar) {
                const areaArchivos = document.getElementById('area_archivos');
                if (areaArchivos) {
                    areaArchivos.style.display = mostrar ? 'block' : 'none';
                    this.log(`✅ Área de archivos ${mostrar ? 'mostrada' : 'ocultada'}`);
                } else {
                    this.log('❌ ERROR: No se encontró el área de archivos');
                }
            }

            mostrarCargandoArchivos(mostrar, mensaje = "Cargando archivos...") {
                const contenedor = document.getElementById('lista_archivos_modal');
                if (!contenedor) return;

                if (mostrar) {
                    contenedor.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="fa fa-spinner fa-spin fa-2x mb-2"></i>
                            <p>${mensaje}</p>
                        </div>
                    `;
                    this.log(`✅ Mostrando indicador de carga: ${mensaje}`);
                }
            }

            testSeleccionCarpeta() {
                this.log('=== TEST DE SELECCIÓN DE CARPETA ===');
                this.seleccionarCarpeta('carpeta_principal', 'Carpeta Principal');
            }

            cerrarModalCarpetas() {
                const modal = document.getElementById('modal_carpetas');
                if (modal) {
                    modal.style.display = 'none';
                    this.log('✅ Modal cerrado');
                }
            }

            limpiarDebug() {
                document.getElementById('debug-output').textContent = '';
                this.log('Debug limpiado');
            }
        }

        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            window.debugArchivos = new DebugArchivos();
        });
    </script>
</body>
</html>
