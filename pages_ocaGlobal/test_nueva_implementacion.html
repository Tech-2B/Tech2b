<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Nueva Implementaci√≥n con obtener_carpetas_plan_accion.php</title>
    <link href="css/administradorClientes.css" rel="stylesheet">
    <link href="css/visorHistorialArchivos.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .test-section h3 {
            color: #00a7b5;
            margin-bottom: 15px;
        }
        .btn-test {
            margin: 5px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .debug-output {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="text-center mb-4">
            <i class="fa fa-sync"></i> Test - Nueva Implementaci√≥n
        </h1>

        <!-- Test de la Nueva L√≥gica -->
        <div class="test-section">
            <h3><i class="fa fa-cogs"></i> Nueva L√≥gica Implementada</h3>
            <p>Ahora <code>obtener_estructura_carpetas.php</code> usa exactamente la misma l√≥gica que <code>obtener_carpetas_plan_accion.php</code>.</p>
            
            <div class="status info">
                <h5>‚úÖ Cambios Realizados:</h5>
                <ul>
                    <li><strong>obtener_estructura_carpetas.php:</strong> Ahora usa <code>$funcionesDrive->obtenerCarpetasPlanAccion()</code></li>
                    <li><strong>JavaScript:</strong> Actualizado para manejar lista plana en lugar de estructura jer√°rquica</li>
                    <li><strong>Compatibilidad:</strong> Mantiene la misma funcionalidad pero con datos correctos</li>
                </ul>
            </div>

            <div class="text-center mb-3">
                <button type="button" class="btn btn-primary btn-lg btn-test" onclick="testNuevaImpl.simularDatosWalmart()">
                    <i class="fa fa-database"></i> Simular Datos WALMART
                </button>
                <button type="button" class="btn btn-success btn-lg btn-test" onclick="testNuevaImpl.abrirModalCompleto()">
                    <i class="fa fa-folder-open"></i> Abrir Modal Completo
                </button>
                <button type="button" class="btn btn-info btn-lg btn-test" onclick="testNuevaImpl.probarSeleccionCarpetas()">
                    <i class="fa fa-mouse-pointer"></i> Probar Selecci√≥n
                </button>
            </div>

            <div id="debug-output" class="debug-output">
                <p class="text-muted">Haz click en los botones para probar la nueva implementaci√≥n.</p>
            </div>
        </div>

        <!-- Test de Comparaci√≥n -->
        <div class="test-section">
            <h3><i class="fa fa-balance-scale"></i> Comparaci√≥n: Antes vs Despu√©s</h3>
            
            <div class="row">
                <div class="col-md-6">
                    <h5>‚ùå Antes (Problem√°tico):</h5>
                    <ul>
                        <li>Consulta compleja con jerarqu√≠a</li>
                        <li>Funci√≥n <code>organizarCarpetasJerarquicamente()</code></li>
                        <li>Depend√≠a de <code>id_carpeta_padre</code> correcto</li>
                        <li>Solo mostraba carpeta principal</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h5>‚úÖ Despu√©s (Solucionado):</h5>
                    <ul>
                        <li>Misma l√≥gica que <code>obtener_carpetas_plan_accion.php</code></li>
                        <li>Lista plana ordenada por fecha</li>
                        <li>No depende de jerarqu√≠a en BD</li>
                        <li>Muestra todas las carpetas</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Instrucciones -->
        <div class="test-section">
            <h3><i class="fa fa-info-circle"></i> Instrucciones de Prueba</h3>
            <ol>
                <li><strong>Simular Datos:</strong> Click en "Simular Datos WALMART" para ver la estructura</li>
                <li><strong>Abrir Modal:</strong> Click en "Abrir Modal Completo" para probar la interfaz</li>
                <li><strong>Probar Selecci√≥n:</strong> Click en "Probar Selecci√≥n" para simular clicks en carpetas</li>
                <li><strong>Verificar Resultado:</strong> Deber√≠as ver 3 carpetas: principal + 2 subcarpetas</li>
            </ol>
        </div>
    </div>

    <!-- Modal de Estructura de Carpetas -->
    <div id="modal_carpetas" class="modal-carpetas">
        <div class="modal-carpetas-contenido">
            <div class="modal-carpetas-header">
                <h5><i class="fa fa-folder"></i> Estructura de Carpetas</h5>
                <span class="modal-carpetas-cerrar" onclick="testNuevaImpl.cerrarModalCarpetas()">&times;</span>
            </div>
            <div class="modal-carpetas-body">
                <!-- Informaci√≥n del plan de acci√≥n seleccionado -->
                <div class="info-plan-seleccionado mb-3">
                    <h6 id="nombre_plan_seleccionado">Plan de Acci√≥n WALMART</h6>
                </div>
                
                <!-- √Årea de carpetas (arriba) -->
                <div class="area-carpetas">
                    <h6><i class="fa fa-folder"></i> Carpetas Disponibles</h6>
                    <div class="arbol-carpetas-modal" id="arbol_carpetas_modal">
                        <div class="text-center text-muted">
                            <i class="fa fa-folder-open fa-2x mb-2"></i>
                            <p>Cargando estructura de carpetas...</p>
                        </div>
                    </div>
                </div>
                
                <!-- √Årea de archivos (abajo) -->
                <div class="area-archivos" id="area_archivos" style="display: none;">
                    <h6><i class="fa fa-file"></i> Archivos de la Carpeta Seleccionada</h6>
                    <div class="lista-archivos-modal" id="lista_archivos_modal">
                        <!-- Los archivos se cargar√°n aqu√≠ din√°micamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        class TestNuevaImplementacion {
            constructor() {
                // Simular datos exactos de WALMART (como los devuelve obtener_carpetas_plan_accion.php)
                this.datosWalmart = [
                    {
                        "id_carpeta_drive": "11ArND6Xhh918eaZl3NjPZtvqha16HVtJ",
                        "nombre_carpeta": "1. Reforzamiento de la estructura del departamento de Servicios HS, asegurando que cada Coordinador HS tenga a su cargo m√°ximo entre 10 y 15 cascos rojos independientes (dependiendo la duraci√≥n de los proyectos y la zona de los mismos)",
                        "tipo_carpeta": "plan_accion",
                        "ruta_completa": "1X6a3VpVkasNg-7dxtukxu7ZQjfGSOcDi/WALMART/ 1. Incrementar la presencia de Coordinadores HS en los sitios de trabajo./ 1. Reforzamiento de la estructura del departamento de Servicios HS, asegurando que cada Coordinador HS tenga a su cargo m√°ximo entre 10 y 15 cascos rojos independientes (dependiendo la duraci√≥n de los proyectos y la zona de los mismos)"
                    },
                    {
                        "id_carpeta_drive": "10RhCxKYvwjm0DIYXtOCHaaHMhNEB-4Tg",
                        "nombre_carpeta": "subcarpeta walmart plan 1.1",
                        "tipo_carpeta": "subcarpeta",
                        "ruta_completa": "ruta_subcarpeta_1"
                    },
                    {
                        "id_carpeta_drive": "1xyUHRFmp1MheOarH8JgwPTK_BFUrfgtG",
                        "nombre_carpeta": "subcarpeta walmart plan 1.2",
                        "tipo_carpeta": "subcarpeta",
                        "ruta_completa": "ruta_subcarpeta_2"
                    }
                ];

                this.archivosEjemplo = [
                    {
                        "id_archivo_drive": "1REjcWzCHTt9oj2UHrwYp1FmwqA7uNPsX",
                        "nombre_archivo_original": "Ced_8206 (1) (1).pdf",
                        "tamano_formateado": "1.22 MB",
                        "fecha_formateada": "16/09/2025 15:17",
                        "icono_tipo": { "icono": "fa-file-pdf", "clase": "pdf" },
                        "url_drive": "#",
                        "url_descarga": "#"
                    },
                    {
                        "id_archivo_drive": "14Rw6v3VkBj2W5yPYfwMjizXPI6Y6dACF",
                        "nombre_archivo_original": "Ced_8206 (1).pdf",
                        "tamano_formateado": "1.22 MB",
                        "fecha_formateada": "16/09/2025 14:27",
                        "icono_tipo": { "icono": "fa-file-pdf", "clase": "pdf" },
                        "url_drive": "#",
                        "url_descarga": "#"
                    }
                ];
            }

            log(message) {
                const output = document.getElementById('debug-output');
                const timestamp = new Date().toLocaleTimeString();
                output.textContent += `[${timestamp}] ${message}\n`;
                output.scrollTop = output.scrollHeight;
            }

            simularDatosWalmart() {
                this.log('=== SIMULANDO DATOS WALMART ===');
                this.log('Datos que devuelve obtener_carpetas_plan_accion.php:');
                this.log(JSON.stringify(this.datosWalmart, null, 2));
                
                this.log(`\nTotal de carpetas: ${this.datosWalmart.length}`);
                this.datosWalmart.forEach((carpeta, index) => {
                    this.log(`${index + 1}. ${carpeta.tipo_carpeta}: ${carpeta.nombre_carpeta}`);
                });

                this.log('\n‚úÖ Ahora el visor deber√≠a mostrar las 3 carpetas correctamente');
            }

            abrirModalCompleto() {
                this.log('=== ABRIENDO MODAL COMPLETO ===');
                
                // Mostrar estructura de carpetas usando la nueva l√≥gica
                this.mostrarEstructuraCarpetas(this.datosWalmart);
                
                // Abrir modal
                const modal = document.getElementById('modal_carpetas');
                if (modal) {
                    modal.style.display = 'block';
                    this.log('‚úÖ Modal abierto con nueva implementaci√≥n');
                } else {
                    this.log('‚ùå ERROR: No se encontr√≥ el modal');
                }
            }

            mostrarEstructuraCarpetas(carpetas) {
                const contenedor = document.getElementById('arbol_carpetas_modal');
                if (!contenedor) {
                    this.log('‚ùå ERROR: No se encontr√≥ el contenedor del √°rbol de carpetas');
                    return;
                }

                this.log(`Mostrando ${carpetas.length} carpetas usando nueva l√≥gica`);

                let html = '';
                carpetas.forEach((carpeta, index) => {
                    // Determinar el nivel basado en el tipo de carpeta
                    const nivel = carpeta.tipo_carpeta === 'plan_accion' ? 0 : 1;
                    html += this.generarHTMLCarpetaLista(carpeta, nivel, index);
                    this.log(`  - ${carpeta.tipo_carpeta}: ${carpeta.nombre_carpeta} (nivel ${nivel})`);
                });

                contenedor.innerHTML = html;
                this.log('‚úÖ Estructura de carpetas mostrada correctamente');
            }

            generarHTMLCarpetaLista(carpeta, nivel, index) {
                const nivelClass = nivel > 0 ? `nivel-${nivel}` : '';
                const icono = carpeta.tipo_carpeta === 'plan_accion' ? 'fa-folder' : 'fa-folder';
                const prefijo = carpeta.tipo_carpeta === 'plan_accion' ? 'üìÅ' : 'üìÇ';
                
                return `
                    <div class="carpeta-item ${nivelClass}" 
                         data-id-carpeta="${carpeta.id_carpeta_drive}" 
                         data-tipo="${carpeta.tipo_carpeta}"
                         onclick="testNuevaImpl.seleccionarCarpeta('${carpeta.id_carpeta_drive}', '${carpeta.nombre_carpeta}')">
                        <i class="fa ${icono} icono-carpeta"></i>
                        <span class="nombre-carpeta">${prefijo} ${carpeta.nombre_carpeta}</span>
                        <span class="contador-archivos" id="contador-${carpeta.id_carpeta_drive}">0</span>
                    </div>
                `;
            }

            seleccionarCarpeta(idCarpetaDrive, nombreCarpeta) {
                this.log(`=== SELECCIONANDO CARPETA ===`);
                this.log(`Carpeta seleccionada: ${nombreCarpeta} (ID: ${idCarpetaDrive})`);
                
                // Actualizar estado visual
                this.actualizarSeleccionCarpetaArbol(idCarpetaDrive);
                
                // Mostrar √°rea de archivos
                this.mostrarAreaArchivos(true);
                
                // Simular carga de archivos
                this.mostrarCargandoArchivos(true, `Cargando archivos de "${nombreCarpeta}"...`);
                
                setTimeout(() => {
                    this.mostrarCargandoArchivos(false);
                    this.mostrarArchivosEnModal(this.archivosEjemplo, nombreCarpeta);
                }, 1000);
            }

            actualizarSeleccionCarpetaArbol(idCarpetaDrive) {
                // Remover selecci√≥n anterior
                document.querySelectorAll('.arbol-carpetas-modal .carpeta-item').forEach(item => {
                    item.classList.remove('seleccionada');
                });

                // Agregar selecci√≥n a la carpeta actual
                const carpetaSeleccionada = document.querySelector(`.arbol-carpetas-modal [data-id-carpeta="${idCarpetaDrive}"]`);
                if (carpetaSeleccionada) {
                    carpetaSeleccionada.classList.add('seleccionada');
                    this.log('‚úÖ Carpeta seleccionada visualmente');
                } else {
                    this.log('‚ùå ERROR: No se encontr√≥ la carpeta para seleccionar');
                }
            }

            mostrarAreaArchivos(mostrar) {
                const areaArchivos = document.getElementById('area_archivos');
                if (areaArchivos) {
                    areaArchivos.style.display = mostrar ? 'block' : 'none';
                    this.log(`‚úÖ √Årea de archivos ${mostrar ? 'mostrada' : 'ocultada'}`);
                }
            }

            mostrarCargandoArchivos(mostrar, mensaje = "Cargando archivos...") {
                const contenedor = document.getElementById('lista_archivos_modal');
                if (!contenedor) return;

                if (mostrar) {
                    contenedor.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="fa fa-spinner fa-spin fa-2x mb-2"></i>
                            <p>${mensaje}</p>
                        </div>
                    `;
                    this.log(`‚úÖ Mostrando indicador de carga: ${mensaje}`);
                }
            }

            mostrarArchivosEnModal(archivos, nombreCarpeta) {
                const contenedor = document.getElementById('lista_archivos_modal');
                if (!contenedor) {
                    this.log('‚ùå ERROR: No se encontr√≥ el contenedor de archivos');
                    return;
                }

                this.log(`Mostrando ${archivos.length} archivos para: ${nombreCarpeta}`);

                if (archivos.length === 0) {
                    contenedor.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="fa fa-file fa-2x mb-2"></i>
                            <p>No hay archivos en "${nombreCarpeta}"</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                archivos.forEach(archivo => {
                    html += this.generarHTMLArchivoModal(archivo);
                });

                contenedor.innerHTML = html;
                this.log('‚úÖ Archivos mostrados correctamente');
            }

            generarHTMLArchivoModal(archivo) {
                return `
                    <div class="archivo-item" onclick="testNuevaImpl.seleccionarArchivo('${archivo.id_archivo_drive}', '${archivo.nombre_archivo_original}')">
                        <i class="fa ${archivo.icono_tipo.icono} icono-archivo ${archivo.icono_tipo.clase}"></i>
                        <span class="nombre-archivo">${archivo.nombre_archivo_original}</span>
                        <span class="tamano-archivo">${archivo.tamano_formateado}</span>
                        <span class="fecha-archivo">${archivo.fecha_formateada}</span>
                        <div class="acciones-archivo">
                            <button class="btn-accion-archivo" onclick="event.stopPropagation(); testNuevaImpl.verArchivo('${archivo.url_drive}')" title="Ver archivo">
                                <i class="fa fa-eye"></i>
                            </button>
                            <button class="btn-accion-archivo" onclick="event.stopPropagation(); testNuevaImpl.descargarArchivo('${archivo.url_descarga}', '${archivo.nombre_archivo_original}')" title="Descargar archivo">
                                <i class="fa fa-download"></i>
                            </button>
                        </div>
                    </div>
                `;
            }

            seleccionarArchivo(idArchivoDrive, nombreArchivo) {
                this.log(`Archivo seleccionado: ${nombreArchivo}`);
                Swal.fire({
                    icon: 'info',
                    title: 'Archivo Seleccionado',
                    text: `Has seleccionado: ${nombreArchivo}`,
                    timer: 2000,
                    showConfirmButton: false
                });
            }

            verArchivo(urlDrive) {
                this.log(`Ver archivo: ${urlDrive}`);
                Swal.fire({
                    icon: 'info',
                    title: 'Ver Archivo',
                    text: 'Funcionalidad de ver archivo simulada',
                    timer: 2000,
                    showConfirmButton: false
                });
            }

            descargarArchivo(urlDescarga, nombreArchivo) {
                this.log(`Descargar archivo: ${nombreArchivo}`);
                Swal.fire({
                    icon: 'success',
                    title: 'Descargar Archivo',
                    text: `Descargando: ${nombreArchivo}`,
                    timer: 2000,
                    showConfirmButton: false
                });
            }

            probarSeleccionCarpetas() {
                this.log('=== PROBANDO SELECCI√ìN DE CARPETAS ===');
                this.log('Simulando selecci√≥n de carpeta principal...');
                this.seleccionarCarpeta('11ArND6Xhh918eaZl3NjPZtvqha16HVtJ', 'Carpeta Principal');
            }

            cerrarModalCarpetas() {
                const modal = document.getElementById('modal_carpetas');
                if (modal) {
                    modal.style.display = 'none';
                    this.log('‚úÖ Modal cerrado');
                }
            }
        }

        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            window.testNuevaImpl = new TestNuevaImplementacion();
        });
    </script>
</body>
</html>
