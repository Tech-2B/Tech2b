<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test del Nuevo Visor de Archivos</title>
    <link href="css/administradorClientes.css" rel="stylesheet">
    <link href="css/visorHistorialArchivos.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .test-section h3 {
            color: #00a7b5;
            margin-bottom: 15px;
        }
        .btn-test {
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="text-center mb-4">
            <i class="fa fa-sitemap"></i> Test del Nuevo Visor de Archivos
        </h1>

        <!-- Test del Modal Rediseñado -->
        <div class="test-section">
            <h3><i class="fa fa-folder-tree"></i> Modal Rediseñado</h3>
            <p>Prueba la nueva estructura del modal con árbol de carpetas y área de archivos separada.</p>
            
            <div class="text-center mb-3">
                <button type="button" class="btn btn-primary btn-lg btn-test" onclick="testNuevoVisor.abrirModalCarpetas()">
                    <i class="fa fa-folder-open"></i> Abrir Modal Rediseñado
                </button>
                <button type="button" class="btn btn-info btn-lg btn-test" onclick="testNuevoVisor.simularEstructuraCompleta()">
                    <i class="fa fa-database"></i> Simular Estructura Completa
                </button>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <h5>Nuevas Funcionalidades:</h5>
                    <ul>
                        <li>✅ Árbol de carpetas en la parte superior</li>
                        <li>✅ Área de archivos en la parte inferior</li>
                        <li>✅ Selección de carpetas con colapso automático</li>
                        <li>✅ Información del plan seleccionado</li>
                        <li>✅ Navegación jerárquica mejorada</li>
                        <li>✅ Acciones de archivos integradas</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h5>Flujo de Navegación:</h5>
                    <ol>
                        <li>Click en "Ver Estructura" de un plan</li>
                        <li>Se abre modal con árbol de carpetas</li>
                        <li>Click en carpeta principal o subcarpeta</li>
                        <li>Se muestran archivos debajo del árbol</li>
                        <li>Click en otra carpeta colapsa la anterior</li>
                        <li>Acciones de ver/descargar archivos</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Test de Responsive -->
        <div class="test-section">
            <h3><i class="fa fa-mobile"></i> Test Responsive</h3>
            <p>Prueba la funcionalidad en diferentes tamaños de pantalla.</p>
            
            <div class="alert alert-info">
                <i class="fa fa-info-circle"></i>
                <strong>Nota:</strong> Redimensiona la ventana del navegador para probar la responsividad del modal rediseñado.
            </div>
        </div>

        <!-- Instrucciones de uso -->
        <div class="test-section">
            <h3><i class="fa fa-question-circle"></i> Instrucciones de Uso</h3>
            <ol>
                <li><strong>Abrir Modal:</strong> Click en "Abrir Modal Rediseñado"</li>
                <li><strong>Ver Estructura:</strong> Observa el árbol de carpetas en la parte superior</li>
                <li><strong>Seleccionar Carpeta:</strong> Click en cualquier carpeta del árbol</li>
                <li><strong>Ver Archivos:</strong> Los archivos aparecen en el área inferior</li>
                <li><strong>Cambiar Carpeta:</strong> Click en otra carpeta para cambiar la vista</li>
                <li><strong>Acciones:</strong> Usa los botones de ver/descargar en cada archivo</li>
                <li><strong>Cerrar:</strong> Click en X, fuera del modal, o presiona Escape</li>
            </ol>
        </div>
    </div>

    <!-- Modal de Estructura de Carpetas -->
    <div id="modal_carpetas" class="modal-carpetas">
        <div class="modal-carpetas-contenido">
            <div class="modal-carpetas-header">
                <h5><i class="fa fa-folder"></i> Estructura de Carpetas</h5>
                <span class="modal-carpetas-cerrar" onclick="testNuevoVisor.cerrarModalCarpetas()">&times;</span>
            </div>
            <div class="modal-carpetas-body">
                <!-- Información del plan de acción seleccionado -->
                <div class="info-plan-seleccionado mb-3">
                    <h6 id="nombre_plan_seleccionado">Cargando...</h6>
                </div>
                
                <!-- Área de carpetas (arriba) -->
                <div class="area-carpetas">
                    <h6><i class="fa fa-folder"></i> Carpetas Disponibles</h6>
                    <div class="arbol-carpetas-modal" id="arbol_carpetas_modal">
                        <div class="text-center text-muted">
                            <i class="fa fa-folder-open fa-2x mb-2"></i>
                            <p>Cargando estructura de carpetas...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Área de archivos (abajo) -->
                <div class="area-archivos" id="area_archivos" style="display: none;">
                    <h6><i class="fa fa-file"></i> Archivos de la Carpeta Seleccionada</h6>
                    <div class="lista-archivos-modal" id="lista_archivos_modal">
                        <!-- Los archivos se cargarán aquí dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        class TestNuevoVisor {
            constructor() {
                this.estructuraEjemplo = [
                    {
                        id_carpeta_drive: 'carpeta_1',
                        nombre_carpeta: 'Plan de Acción Principal',
                        tipo_carpeta: 'plan_accion',
                        subcarpetas: [
                            {
                                id_carpeta_drive: 'subcarpeta_1_1',
                                nombre_carpeta: 'Subcarpeta 1',
                                tipo_carpeta: 'subcarpeta',
                                subcarpetas: []
                            },
                            {
                                id_carpeta_drive: 'subcarpeta_1_2',
                                nombre_carpeta: 'Subcarpeta 2',
                                tipo_carpeta: 'subcarpeta',
                                subcarpetas: []
                            }
                        ]
                    }
                ];

                this.archivosEjemplo = {
                    'carpeta_1': [
                        {
                            id_archivo_drive: 'archivo_1',
                            nombre_archivo_original: 'Documento Principal.pdf',
                            tamano_formateado: '2.5 MB',
                            fecha_formateada: '15/01/2025 10:30',
                            icono_tipo: { icono: 'fa-file-pdf', clase: 'pdf' },
                            url_drive: '#',
                            url_descarga: '#'
                        },
                        {
                            id_archivo_drive: 'archivo_2',
                            nombre_archivo_original: 'Reporte Mensual.xlsx',
                            tamano_formateado: '1.2 MB',
                            fecha_formateada: '14/01/2025 15:45',
                            icono_tipo: { icono: 'fa-file-excel', clase: 'excel' },
                            url_drive: '#',
                            url_descarga: '#'
                        }
                    ],
                    'subcarpeta_1_1': [
                        {
                            id_archivo_drive: 'archivo_3',
                            nombre_archivo_original: 'Archivo Subcarpeta 1.pdf',
                            tamano_formateado: '800 KB',
                            fecha_formateada: '13/01/2025 09:15',
                            icono_tipo: { icono: 'fa-file-pdf', clase: 'pdf' },
                            url_drive: '#',
                            url_descarga: '#'
                        }
                    ],
                    'subcarpeta_1_2': [
                        {
                            id_archivo_drive: 'archivo_4',
                            nombre_archivo_original: 'Documento Subcarpeta 2.docx',
                            tamano_formateado: '600 KB',
                            fecha_formateada: '12/01/2025 14:20',
                            icono_tipo: { icono: 'fa-file-word', clase: 'word' },
                            url_drive: '#',
                            url_descarga: '#'
                        }
                    ]
                };

                this.configurarEventos();
            }

            configurarEventos() {
                // Cerrar modal al hacer click fuera de él
                window.onclick = (event) => {
                    const modal = document.getElementById('modal_carpetas');
                    if (event.target === modal) {
                        this.cerrarModalCarpetas();
                    }
                };

                // Cerrar modal con tecla Escape
                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape') {
                        this.cerrarModalCarpetas();
                    }
                });
            }

            abrirModalCarpetas() {
                const modal = document.getElementById('modal_carpetas');
                if (modal) {
                    modal.style.display = 'block';
                    this.simularEstructuraCompleta();
                }
            }

            cerrarModalCarpetas() {
                const modal = document.getElementById('modal_carpetas');
                if (modal) {
                    modal.style.display = 'none';
                    this.mostrarAreaArchivos(false);
                    document.querySelectorAll('.arbol-carpetas-modal .carpeta-item').forEach(item => {
                        item.classList.remove('seleccionada');
                    });
                }
            }

            simularEstructuraCompleta() {
                this.mostrarNombrePlan('Plan de Acción de Prueba');
                this.mostrarEstructuraCarpetas(this.estructuraEjemplo);
            }

            mostrarNombrePlan(nombrePlan) {
                const elemento = document.getElementById('nombre_plan_seleccionado');
                if (elemento) {
                    elemento.textContent = nombrePlan;
                }
            }

            mostrarEstructuraCarpetas(estructura) {
                const contenedor = document.getElementById('arbol_carpetas_modal');
                if (!contenedor) return;

                let html = '';
                estructura.forEach(carpeta => {
                    html += this.generarHTMLCarpetaArbol(carpeta, 0);
                });

                contenedor.innerHTML = html;
            }

            generarHTMLCarpetaArbol(carpeta, nivel) {
                const nivelClass = nivel > 0 ? `nivel-${nivel}` : '';
                const icono = carpeta.tipo_carpeta === 'plan_accion' ? 'fa-folder' : 'fa-folder';
                
                let html = `
                    <div class="carpeta-item ${nivelClass}" 
                         data-id-carpeta="${carpeta.id_carpeta_drive}" 
                         data-tipo="${carpeta.tipo_carpeta}"
                         onclick="testNuevoVisor.seleccionarCarpeta('${carpeta.id_carpeta_drive}', '${carpeta.nombre_carpeta}')">
                        <i class="fa ${icono} icono-carpeta"></i>
                        <span class="nombre-carpeta">${carpeta.nombre_carpeta}</span>
                        <span class="contador-archivos" id="contador-${carpeta.id_carpeta_drive}">0</span>
                    </div>
                `;

                // Agregar subcarpetas recursivamente
                if (carpeta.subcarpetas && carpeta.subcarpetas.length > 0) {
                    carpeta.subcarpetas.forEach(subcarpeta => {
                        html += this.generarHTMLCarpetaArbol(subcarpeta, nivel + 1);
                    });
                }

                return html;
            }

            seleccionarCarpeta(idCarpetaDrive, nombreCarpeta) {
                // Actualizar estado visual en el árbol
                this.actualizarSeleccionCarpetaArbol(idCarpetaDrive);
                
                // Mostrar área de archivos
                this.mostrarAreaArchivos(true);
                
                // Simular carga de archivos
                this.mostrarCargandoArchivos(true, `Cargando archivos de "${nombreCarpeta}"...`);
                
                setTimeout(() => {
                    this.mostrarCargandoArchivos(false);
                    const archivos = this.archivosEjemplo[idCarpetaDrive] || [];
                    this.mostrarArchivosEnModal(archivos, nombreCarpeta);
                }, 1000);
            }

            actualizarSeleccionCarpetaArbol(idCarpetaDrive) {
                // Remover selección anterior
                document.querySelectorAll('.arbol-carpetas-modal .carpeta-item').forEach(item => {
                    item.classList.remove('seleccionada');
                });

                // Agregar selección a la carpeta actual
                const carpetaSeleccionada = document.querySelector(`.arbol-carpetas-modal [data-id-carpeta="${idCarpetaDrive}"]`);
                if (carpetaSeleccionada) {
                    carpetaSeleccionada.classList.add('seleccionada');
                }
            }

            mostrarAreaArchivos(mostrar) {
                const areaArchivos = document.getElementById('area_archivos');
                if (areaArchivos) {
                    areaArchivos.style.display = mostrar ? 'block' : 'none';
                }
            }

            mostrarCargandoArchivos(mostrar, mensaje = "Cargando archivos...") {
                const contenedor = document.getElementById('lista_archivos_modal');
                if (!contenedor) return;

                if (mostrar) {
                    contenedor.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="fa fa-spinner fa-spin fa-2x mb-2"></i>
                            <p>${mensaje}</p>
                        </div>
                    `;
                }
            }

            mostrarArchivosEnModal(archivos, nombreCarpeta) {
                const contenedor = document.getElementById('lista_archivos_modal');
                if (!contenedor) return;

                if (archivos.length === 0) {
                    contenedor.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="fa fa-file fa-2x mb-2"></i>
                            <p>No hay archivos en "${nombreCarpeta}"</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                archivos.forEach(archivo => {
                    html += this.generarHTMLArchivoModal(archivo);
                });

                contenedor.innerHTML = html;
            }

            generarHTMLArchivoModal(archivo) {
                return `
                    <div class="archivo-item" onclick="testNuevoVisor.seleccionarArchivo('${archivo.id_archivo_drive}', '${archivo.nombre_archivo_original}')">
                        <i class="fa ${archivo.icono_tipo.icono} icono-archivo ${archivo.icono_tipo.clase}"></i>
                        <span class="nombre-archivo">${archivo.nombre_archivo_original}</span>
                        <span class="tamano-archivo">${archivo.tamano_formateado}</span>
                        <span class="fecha-archivo">${archivo.fecha_formateada}</span>
                        <div class="acciones-archivo">
                            <button class="btn-accion-archivo" onclick="event.stopPropagation(); testNuevoVisor.verArchivo('${archivo.url_drive}')" title="Ver archivo">
                                <i class="fa fa-eye"></i>
                            </button>
                            <button class="btn-accion-archivo" onclick="event.stopPropagation(); testNuevoVisor.descargarArchivo('${archivo.url_descarga}', '${archivo.nombre_archivo_original}')" title="Descargar archivo">
                                <i class="fa fa-download"></i>
                            </button>
                        </div>
                    </div>
                `;
            }

            seleccionarArchivo(idArchivoDrive, nombreArchivo) {
                Swal.fire({
                    icon: 'info',
                    title: 'Archivo Seleccionado',
                    text: `Has seleccionado: ${nombreArchivo}`,
                    timer: 2000,
                    showConfirmButton: false
                });
            }

            verArchivo(urlDrive) {
                Swal.fire({
                    icon: 'info',
                    title: 'Ver Archivo',
                    text: 'Funcionalidad de ver archivo simulada',
                    timer: 2000,
                    showConfirmButton: false
                });
            }

            descargarArchivo(urlDescarga, nombreArchivo) {
                Swal.fire({
                    icon: 'success',
                    title: 'Descargar Archivo',
                    text: `Descargando: ${nombreArchivo}`,
                    timer: 2000,
                    showConfirmButton: false
                });
            }
        }

        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            window.testNuevoVisor = new TestNuevoVisor();
        });
    </script>
</body>
</html>
